<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Logic Playground</title>
    <!-- Google Fonts for a friendly, educational look -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="icon" type="image/x-icon" href="favicon.png">

    <style>
        :root {
            /* Cyber Pastel Palette */
            --bg-gradient: linear-gradient(135deg, #E0C3FC 0%, #8EC5FC 100%);
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.8);
            --primary: #6C63FF; /* Deep Pastel Blue/Purple */
            --secondary: #FF6584; /* Soft Red */
            --accent: #43D9AD; /* Mint */
            --text-dark: #2D3436;
            --text-light: #636e72;
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-dark);
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* --- Layout & Glassmorphism --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: var(--shadow);
            padding: 30px;
            transition: transform 0.3s ease;
        }

        button {
            font-family: 'Fredoka', sans-serif;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button:active {
            transform: scale(0.95);
        }

        h1, h2, h3 {
            font-family: 'Fredoka', sans-serif;
            color: var(--primary);
        }

        /* --- Page Switcher Logic --- */
        .page {
            display: none; /* Hidden by default */
            animation: fadeIn 0.5s ease;
            width: 100%;
            height: 100%;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- HOME PAGE --- */
        #home-page {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
        }

        .mascot-container {
            width: 200px;
            height: 200px;
            margin-bottom: 20px;
            position: relative;
            animation: float 3s ease-in-out infinite;
        }

        /* CSS Only 3D Robot */
        .robot-body {
            width: 100px;
            height: 120px;
            background: white;
            border-radius: 30px;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            box-shadow: inset -10px -10px 20px rgba(0,0,0,0.1);
            border: 4px solid var(--primary);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2;
        }
        .robot-face {
            width: 70px;
            height: 50px;
            background: var(--text-dark);
            border-radius: 15px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 10px;
        }
        .robot-eye {
            width: 15px;
            height: 15px;
            background: var(--accent);
            border-radius: 50%;
            animation: blink 4s infinite;
            box-shadow: 0 0 10px var(--accent);
        }
        .robot-antenna {
            width: 8px;
            height: 40px;
            background: var(--secondary);
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1;
        }
        .robot-antenna::after {
            content: '';
            width: 16px;
            height: 16px;
            background: var(--secondary);
            border-radius: 50%;
            position: absolute;
            top: -10px;
            left: -4px;
            box-shadow: 0 0 15px var(--secondary);
        }

        .main-btn {
            padding: 15px 40px;
            font-size: 1.5rem;
            background: var(--primary);
            color: white;
            border-radius: 50px;
            box-shadow: 0 10px 20px rgba(108, 99, 255, 0.3);
            margin-top: 30px;
        }
        .main-btn:hover {
            background: #5a52d5;
            transform: translateY(-3px);
        }

        footer {
            margin-top: auto;
            padding: 20px;
            text-align: center;
            font-size: 0.9rem;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* --- LEVELS PAGE --- */
        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .level-card {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid transparent;
        }
        .level-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }
        .level-icon {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        /* --- BUILDER PAGE --- */
        .builder-layout {
            display: flex;
            gap: 20px;
            height: 80vh;
        }

        @media (max-width: 900px) {
            .builder-layout { flex-direction: column; height: auto; }
        }

        .toolbox {
            flex: 1;
            background: rgba(255,255,255,0.5);
            border-radius: 20px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
        }

        .program-area {
            flex: 2;
            background: rgba(255,255,255,0.9);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border: 2px dashed var(--primary);
        }

        .map-preview {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Blocks */
        .block {
            padding: 12px 15px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: grab;
            display: flex;
            align-items: center;
            gap: 10px;
            user-select: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .block.move { background: var(--primary); }
        .block.turn { background: var(--secondary); }
        .block.loop { background: var(--accent); color: #1a4436; }
        
        .program-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .program-block {
            cursor: pointer;
            transition: transform 0.1s;
            display: flex;
            justify-content: space-between;
        }
        .program-block:hover { transform: scale(1.02); }
        .delete-x { opacity: 0.6; font-size: 0.8rem; }

        /* Map Grid */
        .grid-container {
            background: white;
            border-radius: 15px;
            padding: 10px;
            display: grid;
            gap: 4px;
            aspect-ratio: 1;
            width: 100%;
            margin: 0 auto;
            position: relative;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }

        .cell {
            background: #f0f2f5;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .cell.wall { background: #2D3436; }
        .cell.start { background: #a8e6cf; border: 2px solid var(--accent); }
        .cell.goal { background: #ff8b94; border: 2px solid var(--secondary); }
        .cell.goal::after { content: 'â˜…'; position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); color: white; }
        
        /* Editor Toggles */
        .map-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .tool-btn {
            padding: 5px 10px;
            font-size: 0.8rem;
            background: white;
            border-radius: 8px;
            color: var(--text-light);
        }
        .tool-btn.active {
            background: var(--primary);
            color: white;
        }

        .action-row {
            margin-top: auto;
            display: flex;
            gap: 10px;
        }
        .run-btn {
            flex: 1;
            padding: 15px;
            background: var(--accent);
            color: #1a4436;
            font-weight: bold;
            border-radius: 15px;
            font-size: 1.2rem;
        }

        /* --- SIMULATION PAGE --- */
        .sim-layout {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .sim-controls {
            display: flex;
            gap: 15px;
            background: white;
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .sim-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sim-btn:hover { background: var(--bg-gradient); color: white; }

        /* Robot in Grid */
        .robot-token {
            position: absolute;
            width: calc(100% / var(--grid-size) - 8px);
            height: calc(100% / var(--grid-size) - 8px);
            background: var(--primary);
            border-radius: 50%;
            z-index: 10;
            transition: all 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(108, 99, 255, 0.4);
            margin: 4px;
        }
        .robot-token svg {
            color: white;
            width: 70%;
            height: 70%;
        }

        /* Helper Classes */
        .header-nav {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
        }
        .back-btn {
            background: white;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }
        @keyframes blink {
            0%, 45%, 55%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.1); }
        }
    </style>
</head>
<body>

<div class="container">

    <!-- HOME PAGE -->
    <div id="home-page" class="page active">
        <div class="glass-panel" style="padding: 60px; max-width: 600px; width: 100%;">
            <div class="mascot-container">
                <div class="robot-antenna"></div>
                <div class="robot-body">
                    <div class="robot-face">
                        <div class="robot-eye"></div>
                        <div class="robot-eye"></div>
                    </div>
                </div>
            </div>
            <h1>Robot Logic Playground</h1>
            <p style="margin-top: 15px; color: var(--text-light);">
                Learn logic by guiding the robot through the maze!<br>
                Drag blocks, avoid walls, and reach the star.
            </p>
            <button class="main-btn" onclick="navTo('levels-page')">Enter Playground</button>
        </div>
    </div>

    <!-- LEVELS PAGE -->
    <div id="levels-page" class="page">
        <div class="glass-panel">
            <div class="header-nav">
                <button class="back-btn" onclick="navTo('home-page')"><i data-lucide="arrow-left"></i></button>
                <h2>Select Level</h2>
            </div>
            <div class="level-grid">
                <!-- Levels injected by JS -->
                <div class="level-card" onclick="loadLevel(0)">
                    <div class="level-icon">1</div>
                    <h3>The Basics</h3>
                    <p>Move straight to the goal.</p>
                </div>
                <div class="level-card" onclick="loadLevel(1)">
                    <div class="level-icon">2</div>
                    <h3>The Turn</h3>
                    <p>Learn to rotate left and right.</p>
                </div>
                <div class="level-card" onclick="loadLevel(2)">
                    <div class="level-icon">3</div>
                    <h3>The Zig Zag</h3>
                    <p>Combine moves and turns.</p>
                </div>
                <div class="level-card" style="border: 2px dashed var(--text-light);" onclick="loadLevel('custom')">
                    <div class="level-icon"><i data-lucide="edit-3"></i></div>
                    <h3>Custom Map</h3>
                    <p>Build your own obstacles!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- BUILDER PAGE -->
    <div id="builder-page" class="page">
        <div class="glass-panel" style="height: 100%;">
            <div class="header-nav">
                <button class="back-btn" onclick="navTo('levels-page')"><i data-lucide="arrow-left"></i></button>
                <h2 id="level-title">Level Builder</h2>
            </div>

            <div class="builder-layout">
                <!-- Toolbox -->
                <div class="toolbox">
                    <h4 style="margin-bottom:10px; color:var(--text-light)">Commands</h4>
                    <div class="block move" onclick="addCommand('move')">
                        <i data-lucide="move-up"></i> Move Forward
                    </div>
                    <div class="block turn" onclick="addCommand('left')">
                        <i data-lucide="rotate-ccw"></i> Turn Left
                    </div>
                    <div class="block turn" onclick="addCommand('right')">
                        <i data-lucide="rotate-cw"></i> Turn Right
                    </div>
                    <div class="block loop" onclick="addCommand('loop2')">
                        <i data-lucide="repeat"></i> Repeat Next Ã— 2
                    </div>
                    <div class="block loop" onclick="addCommand('loop3')">
                        <i data-lucide="repeat"></i> Repeat Next Ã— 3
                    </div>
                    <div style="margin-top: auto; font-size: 0.8rem; color: var(--text-light); text-align: center;">
                        Click to add
                    </div>
                </div>

                <!-- Program Area -->
                <div class="program-area">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <h4>Program Sequence</h4>
                        <button style="color: var(--secondary)" onclick="clearProgram()"><i data-lucide="trash-2"></i> Clear</button>
                    </div>
                    <div class="program-list" id="program-list">
                        <!-- Blocks go here -->
                        <div style="text-align:center; color: #ccc; margin-top: 50px;">Add commands here...</div>
                    </div>
                    <div class="action-row">
                        <button class="run-btn" onclick="startSimulation()">
                            <i data-lucide="play"></i> Run Simulation
                        </button>
                    </div>
                </div>

                <!-- Map Preview / Editor -->
                <div class="map-preview">
                    <div style="display:flex; justify-content:space-between;">
                        <h4>Map Preview</h4>
                        <div id="edit-tools" class="map-controls" style="display:none;">
                            <button class="tool-btn active" onclick="setTool('wall')">Wall</button>
                            <button class="tool-btn" onclick="setTool('start')">Start</button>
                            <button class="tool-btn" onclick="setTool('goal')">Goal</button>
                        </div>
                    </div>
                    <div id="builder-grid" class="grid-container">
                        <!-- Grid Cells JS -->
                    </div>
                    <p style="font-size: 0.8rem; color: var(--text-light); text-align: center;">
                        <span id="edit-hint" style="display:none;">Click grid to place walls/start/goal.</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- SIMULATION PAGE -->
    <div id="simulation-page" class="page">
        <div class="glass-panel">
            <div class="header-nav">
                <button class="back-btn" onclick="stopSimulation(); navTo('builder-page')"><i data-lucide="edit-2"></i></button>
                <h2>Simulation</h2>
            </div>
            
            <div class="sim-layout">
                <!-- Larger Sim Grid -->
                <div id="sim-grid" class="grid-container" style="max-width: 500px;">
                    <!-- Robot Token injected here -->
                </div>

                <div class="sim-controls">
                    <button class="sim-btn" onclick="resetSim()" title="Reset"><i data-lucide="rotate-ccw"></i></button>
                    <button class="sim-btn" onclick="togglePause()" id="play-pause-btn" title="Play/Pause"><i data-lucide="pause"></i></button>
                    <button class="sim-btn" onclick="stepSim()" title="Step"><i data-lucide="skip-forward"></i></button>
                </div>
                
                <div id="sim-status" style="height: 24px; font-weight: bold; color: var(--primary);">Running...</div>
            </div>
        </div>
    </div>

</div>

<footer>
    Class 9 â€” Supervisor: Mam Komal
</footer>

<script>
    // --- STATE MANAGEMENT ---
    const STATE = {
        currentLevelIndex: 0,
        gridSize: 6,
        mapData: [], // 0: empty, 1: wall, 2: start, 3: goal
        program: [],
        startPos: {x:0, y:0, dir:1}, // dir: 0=N, 1=E, 2=S, 3=W
        robot: {x:0, y:0, dir:1},
        editTool: 'wall',
        simInterval: null,
        isPaused: false,
        isRunning: false,
        stepDelay: 800
    };

    // --- PRESET LEVELS ---
    const LEVELS = [
        {
            name: "Level 1: The Basics",
            size: 5,
            // Flattened grid
            map: [
                0,0,0,0,0,
                0,0,0,0,0,
                2,0,0,3,0,
                0,0,0,0,0,
                0,0,0,0,0
            ],
            startDir: 1
        },
        {
            name: "Level 2: The Turn",
            size: 5,
            map: [
                0,0,0,3,0,
                0,0,0,0,0,
                0,0,1,1,0,
                2,0,0,0,0,
                0,0,0,0,0
            ],
            startDir: 1
        },
        {
            name: "Level 3: Zig Zag",
            size: 6,
            map: [
                0,0,0,0,0,3,
                0,1,1,1,1,0,
                0,0,0,0,1,0,
                1,1,1,0,1,0,
                2,0,0,0,0,0,
                0,0,0,0,0,0
            ],
            startDir: 1
        }
    ];

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
    });

    // --- NAVIGATION ---
    function navTo(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        lucide.createIcons();
    }

    // --- BUILDER LOGIC ---

    function loadLevel(index) {
        STATE.program = [];
        updateProgramUI();

        if (index === 'custom') {
            STATE.currentLevelIndex = -1;
            STATE.gridSize = 6;
            STATE.mapData = Array(36).fill(0);
            STATE.mapData[0] = 2; // Default start
            STATE.mapData[35] = 3; // Default goal
            STATE.startPos = {x:0, y:0, dir:1};
            
            document.getElementById('level-title').innerText = "Custom Builder";
            document.getElementById('edit-tools').style.display = 'flex';
            document.getElementById('edit-hint').style.display = 'block';
        } else {
            STATE.currentLevelIndex = index;
            const lvl = LEVELS[index];
            STATE.gridSize = lvl.size;
            STATE.mapData = [...lvl.map];
            
            // Find start pos
            const idx = STATE.mapData.indexOf(2);
            STATE.startPos = {
                x: idx % STATE.gridSize,
                y: Math.floor(idx / STATE.gridSize),
                dir: lvl.startDir
            };

            document.getElementById('level-title').innerText = lvl.name;
            document.getElementById('edit-tools').style.display = 'none';
            document.getElementById('edit-hint').style.display = 'none';
        }
        
        renderGrid('builder-grid', true);
        navTo('builder-page');
    }

    function setTool(tool) {
        STATE.editTool = tool;
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    }

    function toggleCell(index) {
        if (STATE.currentLevelIndex !== -1) return; // Only editable in custom mode

        const current = STATE.mapData[index];
        
        if (STATE.editTool === 'wall') {
            STATE.mapData[index] = (current === 1) ? 0 : 1;
        } else if (STATE.editTool === 'start') {
            // Clear old start
            const old = STATE.mapData.indexOf(2);
            if(old !== -1) STATE.mapData[old] = 0;
            STATE.mapData[index] = 2;
            // Update Start logic
            STATE.startPos.x = index % STATE.gridSize;
            STATE.startPos.y = Math.floor(index / STATE.gridSize);
        } else if (STATE.editTool === 'goal') {
            const old = STATE.mapData.indexOf(3);
            if(old !== -1) STATE.mapData[old] = 0;
            STATE.mapData[index] = 3;
        }
        renderGrid('builder-grid', true);
    }

    function renderGrid(containerId, interactive) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        container.style.setProperty('--grid-size', STATE.gridSize);
        container.style.gridTemplateColumns = `repeat(${STATE.gridSize}, 1fr)`;

        STATE.mapData.forEach((val, idx) => {
            const cell = document.createElement('div');
            cell.className = 'cell';
            if (val === 1) cell.classList.add('wall');
            if (val === 2) cell.classList.add('start');
            if (val === 3) cell.classList.add('goal');
            
            if (interactive && STATE.currentLevelIndex === -1) {
                cell.onclick = () => toggleCell(idx);
            }
            container.appendChild(cell);
        });
    }

    // --- PROGRAMMING LOGIC ---

    function addCommand(type) {
        STATE.program.push({ type, id: Date.now() });
        updateProgramUI();
    }

    function removeCommand(index) {
        STATE.program.splice(index, 1);
        updateProgramUI();
    }

    function clearProgram() {
        STATE.program = [];
        updateProgramUI();
    }

    function updateProgramUI() {
        const list = document.getElementById('program-list');
        list.innerHTML = '';
        if (STATE.program.length === 0) {
            list.innerHTML = '<div style="text-align:center; color: #aaa; margin-top: 20px;">No commands yet.</div>';
            return;
        }

        STATE.program.forEach((cmd, index) => {
            const el = document.createElement('div');
            let label = "";
            let icon = "";
            let cls = "";

            if(cmd.type === 'move') { label = "Move Forward"; icon="move-up"; cls="move"; }
            if(cmd.type === 'left') { label = "Turn Left"; icon="rotate-ccw"; cls="turn"; }
            if(cmd.type === 'right') { label = "Turn Right"; icon="rotate-cw"; cls="turn"; }
            if(cmd.type === 'loop2') { label = "Repeat Next Ã— 2"; icon="repeat"; cls="loop"; }
            if(cmd.type === 'loop3') { label = "Repeat Next Ã— 3"; icon="repeat"; cls="loop"; }

            el.className = `block program-block ${cls}`;
            el.innerHTML = `<div style="display:flex; align-items:center; gap:8px;"><i data-lucide="${icon}" width="16"></i> ${label}</div> <span class="delete-x" onclick="event.stopPropagation(); removeCommand(${index})">âœ•</span>`;
            list.appendChild(el);
        });
        lucide.createIcons();
    }

    // --- SIMULATION LOGIC ---

    function startSimulation() {
        // Compile Logic (Flatten Loops)
        const compiled = [];
        for (let i=0; i<STATE.program.length; i++) {
            const cmd = STATE.program[i];
            if (cmd.type.startsWith('loop')) {
                const count = parseInt(cmd.type.replace('loop',''));
                const nextCmd = STATE.program[i+1];
                if (nextCmd) {
                    for(let k=0; k<count; k++) compiled.push(nextCmd.type);
                    i++; // Skip the next command as it's now handled
                }
            } else {
                compiled.push(cmd.type);
            }
        }

        if(compiled.length === 0) {
            alert("Please add commands first!");
            return;
        }

        STATE.executionQueue = compiled;
        STATE.executionIndex = 0;
        STATE.robot = { ...STATE.startPos };
        
        navTo('simulation-page');
        renderGrid('sim-grid', false);
        createRobotToken();
        updateRobotVisual();
        
        STATE.isRunning = true;
        STATE.isPaused = false;
        updateSimControls();
        
        setTimeout(() => {
            STATE.simInterval = setInterval(gameLoop, STATE.stepDelay);
        }, 500);
    }

    function createRobotToken() {
        // Remove existing
        const exist = document.querySelector('.robot-token');
        if(exist) exist.remove();

        const token = document.createElement('div');
        token.className = 'robot-token';
        token.innerHTML = `<i data-lucide="bot"></i>`;
        document.getElementById('sim-grid').appendChild(token);
        lucide.createIcons();
    }

    function updateRobotVisual() {
        const token = document.querySelector('.robot-token');
        const sizePct = 100 / STATE.gridSize;
        
        token.style.width = `calc(${sizePct}% - 8px)`;
        token.style.height = `calc(${sizePct}% - 8px)`;
        
        // Grid pos to CSS pos
        token.style.left = (STATE.robot.x * sizePct) + '%';
        token.style.top = (STATE.robot.y * sizePct) + '%';

        // Rotation
        // 0=N (rotate 0deg? No, icons usually face up or right. Let's assume icon faces Up)
        // Directions: 0:N, 1:E, 2:S, 3:W
        const rotation = STATE.robot.dir * 90;
        token.style.transform = `rotate(${rotation}deg)`;
    }

    function gameLoop() {
        if (STATE.isPaused) return;

        if (STATE.executionIndex >= STATE.executionQueue.length) {
            endSimulation("End of program.");
            return;
        }

        const cmd = STATE.executionQueue[STATE.executionIndex];
        executeCommand(cmd);
        updateRobotVisual();
        checkWinCondition();
        
        STATE.executionIndex++;
        
        const status = document.getElementById('sim-status');
        status.innerText = `Step ${STATE.executionIndex} / ${STATE.executionQueue.length}`;
    }

    function executeCommand(type) {
        // 0:N, 1:E, 2:S, 3:W
        if (type === 'left') {
            STATE.robot.dir = (STATE.robot.dir + 3) % 4;
        } else if (type === 'right') {
            STATE.robot.dir = (STATE.robot.dir + 1) % 4;
        } else if (type === 'move') {
            let nextX = STATE.robot.x;
            let nextY = STATE.robot.y;

            if (STATE.robot.dir === 0) nextY--;
            if (STATE.robot.dir === 1) nextX++;
            if (STATE.robot.dir === 2) nextY++;
            if (STATE.robot.dir === 3) nextX--;

            // Checks
            if (nextX >= 0 && nextX < STATE.gridSize && nextY >= 0 && nextY < STATE.gridSize) {
                const cellIdx = nextY * STATE.gridSize + nextX;
                if (STATE.mapData[cellIdx] !== 1) {
                    STATE.robot.x = nextX;
                    STATE.robot.y = nextY;
                } else {
                    shakeRobot(); // Hit wall
                }
            } else {
                shakeRobot(); // Out of bounds
            }
        }
    }

    function checkWinCondition() {
        const idx = STATE.robot.y * STATE.gridSize + STATE.robot.x;
        if (STATE.mapData[idx] === 3) {
            clearInterval(STATE.simInterval);
            document.getElementById('sim-status').innerText = "Goal Reached! ðŸŽ‰";
            document.getElementById('sim-status').style.color = "var(--accent)";
            // Celebrate animation
            document.querySelector('.robot-token').style.transform += " scale(1.5)";
        }
    }

    function shakeRobot() {
        const token = document.querySelector('.robot-token');
        token.style.borderColor = 'red';
        setTimeout(() => token.style.borderColor = 'transparent', 300);
    }

    function endSimulation(msg) {
        clearInterval(STATE.simInterval);
        STATE.isRunning = false;
        document.getElementById('sim-status').innerText = msg;
        updateSimControls();
    }

    function togglePause() {
        STATE.isPaused = !STATE.isPaused;
        updateSimControls();
    }

    function stepSim() {
        STATE.isPaused = true;
        updateSimControls();
        gameLoop();
    }

    function resetSim() {
        clearInterval(STATE.simInterval);
        STATE.executionIndex = 0;
        STATE.robot = { ...STATE.startPos };
        updateRobotVisual();
        document.getElementById('sim-status').innerText = "Ready";
        STATE.isRunning = false;
        STATE.isPaused = true;
        updateSimControls();
    }

    function updateSimControls() {
        const playIcon = STATE.isPaused || !STATE.isRunning ? 'play' : 'pause';
        document.getElementById('play-pause-btn').innerHTML = `<i data-lucide="${playIcon}"></i>`;
        lucide.createIcons();
    }
    
    function stopSimulation() {
        clearInterval(STATE.simInterval);
    }

</script>

</body>
</html>